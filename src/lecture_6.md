# Лекция 6.

## Интернет с точки зрения провайдера

Рассмотрим процесс подключения к интернету с точки зрения провайдера.
У маленького провайдера (допустим, RINET) есть автономная система.
Обычно RINET идёт к большому провайдеру (Ростелеком) и платит деньги за то, чтобы тот доставлял весь трафик до интернета, потому что у маленького провайдера нет прямых соединений до автономных систем.
Ростелеком рассказывает RINET через BGP пути до всего интернета (через себя).

Когда пользователь приходит к RINET и открывает страничку google.com, RINET отправляет запрос через Ростелеком до гугла.
Проблема такого подхода — RINET не хочет платить Ростелекому. 
При увеличении размеров RINET проводит прямое соединение до ближайшего маршрутизатора гугла (физически проводит оптоволокно), т.е. устанавливает прямое соединение с автономной системой гугла.
Такой прямой линк называется **пиринг**.

Но если RINET недостаточно большой, то гугл не захочет делать пиринг, т.к. им на это нужно резевировать порт, проводить оптику и т.д.

Есть организации, называемые **Internet Exchange**, например MIX (Moscow IX) или DATAIX.
У таких организаций есть своя автономная система, в неё воткнуты различные провайдеры и контент-генераторы.
Они выполняют роль агрегатора, который позволяет провайдерам связаться с контент-генераторами в обход больших провайдеров.

На самом деле есть несколько **Tier-1** провайдеров (штук 5), к которым подключены все автономные системы напрямую или через транзитных провайдеров (Ростелеком в нашем примере).
Например, Ростелеком, если нет прямого соединения до АС, идет к COGENT, платит ему денег и подключается к АС через него.

### Блокировки

COGENT отключил транзит для российских провайдеров.
Это ломает фундаментальный факт того, что все провайдеры подключены ко всем Tier-1 провайдерам.
От этого не все сломалось, но если все Tier-1 провайдеры так сделают, то нарушится связность с мелкими сайтами, которые находятся далеко.

Также Internet Exchange-и могут отключать российских провайдеров, это более страшно, т.к. тогда не хватит пропускной способности каналов.

Блокировки со стороны России выполняются через крупных провайдеров, т.к. почти весь трафик идёт через них.

Самый простой тип блокировки — перехватывать DNS и выдавать неверный ответ.
Это обходится, если использовать DNS over HTTPS.

Также можно блокировать по ip-адресу сайта.
Но часто на одном адресе много сайтов, поэтому нужно смотреть внутрь пакетов.
Если используется HTTPS (а следовательно и TLS), то в пакете написан домен сайта, поэтому можно блокировать по домену.
Есть хак — можно разрезать пакет в том месте, где находится домен.

В РФ у провайдеров стоят железки, именуемые ТСПУ, которые просят маршрутизаторы пересылать трафик с интересных IP адресов в ТСПУ.
ТСПУ делает DPI (Deep Packet Inspection) и либо отправляет пакеты дальше, либо банит.

VPN банятся в основном по номеру порта, на который он идёт.
Это делают в основном в Китае, в России банят хипстерские впны, которые не используют компании.