<!DOCTYPE HTML>
<html lang="ru" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Лекция 3. IP+Ethernet - Конспект по сетям</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="lecture_1.html"><strong aria-hidden="true">1.</strong> Лекция 1 Введение</a></li><li class="chapter-item expanded "><a href="lecture_2.html"><strong aria-hidden="true">2.</strong> Лекция 2. IP</a></li><li class="chapter-item expanded "><a href="lecture_3.html" class="active"><strong aria-hidden="true">3.</strong> Лекция 3. IP+Ethernet</a></li><li class="chapter-item expanded "><a href="lecture_4.html"><strong aria-hidden="true">4.</strong> Лекция 4. TCP, UDP</a></li><li class="chapter-item expanded "><a href="lecture_5.html"><strong aria-hidden="true">5.</strong> Лекция 5. Роутинг</a></li><li class="chapter-item expanded "><a href="lecture_6.html"><strong aria-hidden="true">6.</strong> Лекция 6.</a></li><li class="chapter-item expanded "><a href="lecture_7.html"><strong aria-hidden="true">7.</strong> Лекция 7. DNS</a></li><li class="chapter-item expanded "><a href="lecture_8.html"><strong aria-hidden="true">8.</strong> Лекция 8. HTTP(S)</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Конспект по сетям</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="Лекция-3-ipethernet"><a class="header" href="#Лекция-3-ipethernet">Лекция 3. IP+Ethernet</a></h1>
<h2 id="icmp"><a class="header" href="#icmp">ICMP</a></h2>
<p>ICMP — Internet Control Message Protocol.
Работает поверх IP и передает служебную информацию.
В ICMP много видов сообщений, мы поговорим только о нескольких.
В поле Protocol для IP пишется номер вида ICMP.</p>
<ul>
<li>ICMP Echo Request/Reply - через него работает ping.</li>
<li>ICMP Destination Unreachable - при передаче пакет не достиг пункта назначения.
Поля показывают одно из:
<ul>
<li>Fragmentation required - пакет больше MTU и выставлен Do not fragment в IP заголовке.</li>
<li>Destination host unreachable</li>
<li>Destination network unreachable</li>
<li>Destination port unreachable - порт (TCP/UDP) не может принять</li>
<li>* administratively prohibited - бан от файервола</li>
</ul>
</li>
<li>Time Exceeded - TTL истек. </li>
<li>Trace Route - все промежуточные узлы должны отправить вам пакет.
Есть проблема: можно поставить в src человека, который нам не нравится.
Тогда если мы отправим один пакет Trace Route, человек получит много пакетов с разных адресов, это amplification атака и очень плохо.
В итоге Trace Route забанен.
В целом в ICMP требуют, чтобы возвращаемый пакет был не больше исходного пакета, чтобы не было атак.
Кроме того, если пакет Time Exceeded потерян, то нельзя посылать ответный Time Exceeded по тем же причинам.</li>
</ul>
<h2 id="Мелочи"><a class="header" href="#Мелочи">Мелочи</a></h2>
<ul>
<li>NAT64 - способ для IPv6 узлов общаться с узлами, которые v6 не понимают.
Он похож на NAT, просто переписывает адреса.</li>
<li>whois - утилита, позволяющая узнать по ip-адресу, кому принадлежит адрес, куда жаловаться если с этого адреса атаки, подсеть и т.д.</li>
<li>tcpdump - показывает все пакеты, идущие по некоторому интерфейсу на компьютере</li>
<li>wireshark - графическая программа, позволяющая просматривать пакеты.</li>
</ul>
<h2 id="ethernet-и-wifi"><a class="header" href="#ethernet-и-wifi">Ethernet и WiFi</a></h2>
<p>Эти протоколы стандартизованы IEEE (той самой, которая флоаты).
Ethernet — 802.3, а WiFi — 802.11.</p>
<p>Для link протоколов тоже нужны адреса и мы не можем использовать IP.
Поэтому используются MAC-адреса.
Они обычно записываются в виде шести пар шестнадцатеричных цифр, например, 00:11:22:33:44:55.
Broadcast (всем в локальной сети) MAC-адрес это ff:ff:ff:ff:ff:ff.</p>
<p><img src="img/eth_packet.png" alt="ethernet frame" /></p>
<p>Существуют разные &quot;коробочки&quot;, которые могут быть использованы для передачи пакетов:</p>
<ul>
<li>Хаб (L1): без логики пересылает все сообщения всем подключенным клиентам. Сейчас почти не используются, т.к. они медленные.</li>
<li>Коммутатор или свитч (L2): смотрит на dst адрес пакета и направляет туда, где dst находится.
Расположение узлов коммутатор узнает, смотря на src адрес пакетов, исходящих от каждого узла.
Если коммутаторы образуют не дерево, то все плохо — фреймы могут ходить по циклу (TTL нет), множиться и т.д.
Простейший способ бороться с этим — не создавать циклы.
Большинство коммутаторов, если видит mac-адрес на двух портах, то выключает один из них.</li>
<li>Маршрутизатор (L3): то же самое, но на IP адресах, а не mac адресах. </li>
</ul>
<h2 id="mac-адреса"><a class="header" href="#mac-адреса">MAC-адреса</a></h2>
<p>Шесть октетов адреса делятся пополам. Первые три октета — уникальный номер организации (полученный в IEEE).
Оставшиеся октеты выставляются организацией произвольно, обычно последовательно.
Проблема: \(2^{24}\) адресов — мало для одной организации. Когда они кончаются, есть два варианта:</p>
<ul>
<li>Получить новый номер организации, но это сложно.</li>
<li>Сделать идентификаторы не уникальными и использовать их заново.
Тогда надо надеяться на то, что в рамках одной L2 сети адреса не повторяются, иначе все сломается.</li>
</ul>
<p>В mac адресах есть два особых бита:</p>
<ul>
<li>Последний бит первого октета — multicast или unicast (редкость).</li>
<li>Предпоследний бит первого октета — если он не выставлен, то mac адрес честный, иначе он придуман локально.</li>
</ul>
<p>У виртуалок и всяких докеров тоже есть честные MAC адреса.</p>
<h2 id="arp-address-resultion-protocol"><a class="header" href="#arp-address-resultion-protocol">ARP (Address Resultion Protocol)</a></h2>
<p>Мы хотим отправить пакет кому-то на IP адрес, но мы не знаем его MAC адреса.
Отправим сообщение на <code>ff:...:ff</code>: &quot;у кого есть такой-то IP адрес?&quot;
Если у кого-то есть этот адрес, он должен ответить и сказать свой MAC адрес.</p>
<p>В ARP есть таймауты, по которым мы говорим, что запись старая или удаляем запись вообще.</p>
<h2 id="nd-neighbor-discovery-protocol"><a class="header" href="#nd-neighbor-discovery-protocol">ND (Neighbor Discovery Protocol)</a></h2>
<p>Это то же самое, что и ARP, но для IPv6.
ND ещё умеет узнавать, кто является роутером в сети (Router discovery) и Redirection - роутер может сказать, что он больше не роутер и сказать, кто теперь является роутером.</p>
<h2 id="dhcp"><a class="header" href="#dhcp">DHCP</a></h2>
<p>Допустим мы подключили наш ноутбук к сети.
Нам нужен IP адрес, чтобы общаться, при этом адрес должен быть из правильной сети и уникальный.</p>
<p>Простейший способ это сделать — выставить руками, в линуксе это <code>ip addr</code>, но это не универсальный вариант.
Для получения IP адреса используется протокол DHCP.
Он работает поверх UDP, который работает поверх IP.
Чтобы отправить пакет IP, нужно иметь какой-то IP адрес.
Тупик? Не совсем, будем писать в src 0.0.0.0</p>
<ol>
<li>Отправляем запрос DHCP Discover всем (255.255.255.255) от никого (0.0.0.0).</li>
<li>Тот, кто выдает адреса, выдает адрес и шлёт уже на этот адрес пакет DHCP Offer.
Потенциально DHCP серверов в сети несколько, поэтому и таких пакетов может прийти несколько.
В это время запрашивающее устройство слушает все пакеты, приходящие на его MAC адрес.</li>
<li>Запрашивающее устройство выбирает понравившийся адрес и отправляет (с него) DHCP Request.</li>
<li>Сервер отправляет DHCP ACK.</li>
</ol>
<p>Адреса не даются навсегда, только на время lease timeout.
Если устройство не хочет, чтобы по истечении таймаута менялся адрес, выполняется опять DHCP Request.
При этом сервер может ответить DHCPNAK и не продлевать. </p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="lecture_2.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="lecture_4.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="lecture_2.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="lecture_4.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
