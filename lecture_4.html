<!DOCTYPE HTML>
<html lang="ru" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Лекция 4. TCP, UDP - Конспект по сетям</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="lecture_1.html"><strong aria-hidden="true">1.</strong> Лекция 1 Введение</a></li><li class="chapter-item expanded "><a href="lecture_2.html"><strong aria-hidden="true">2.</strong> Лекция 2. IP</a></li><li class="chapter-item expanded "><a href="lecture_3.html"><strong aria-hidden="true">3.</strong> Лекция 3. IP+Ethernet</a></li><li class="chapter-item expanded "><a href="lecture_4.html" class="active"><strong aria-hidden="true">4.</strong> Лекция 4. TCP, UDP</a></li><li class="chapter-item expanded "><a href="lecture_5.html"><strong aria-hidden="true">5.</strong> Лекция 5. Роутинг</a></li><li class="chapter-item expanded "><a href="lecture_6.html"><strong aria-hidden="true">6.</strong> Лекция 6.</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Конспект по сетям</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="Лекция-4-tcp-udp"><a class="header" href="#Лекция-4-tcp-udp">Лекция 4. TCP, UDP.</a></h1>
<h2 id="udp"><a class="header" href="#udp">UDP</a></h2>
<p>На одном компьютере может быть запущено много приложений, слушающих пакеты, поэтому у нас существуют <strong>порты</strong>.
Это числа от 1 до 65535, 0 - особое.</p>
<p>UDP датаграмма состоит из полей:</p>
<ul>
<li>Source port</li>
<li>Destination port</li>
<li>Length - казалось бы, в IP пакете она и так есть, но технически UDP не обязан работать поверх IP.</li>
<li>Checksum - включает в себя и чексумму payload. Если она не совпадает, пакет выкидывается.</li>
<li>Payload</li>
</ul>
<p>Порты до 1024 зарезервированы для root приложений, чтобы левые программы не поднимали веб-сервера.</p>
<p><code>netcat</code> - полезная утилита, которая позволяет передавать и слушать UPD пакеты.</p>
<p>Часто мы хотим передавать данные, которые не влезают в один пакет UDP.
Для этого мы рассмотрим протокол TFTP, он полезен для понимания TCP.</p>
<h3 id="tftp"><a class="header" href="#tftp">TFTP</a></h3>
<p>Разобьём данные на куски, которые влезают в пакеты.
Сервер отправляет первый кусок данных и ждёт подтверждения от клиента.
После этого сервер отправляет второй кусок данных и т.д.</p>
<p>TFTP используется в network boot, т.к. он очень простой.</p>
<p>Но TFTP работает быстро, только если задержка между сервером и клиентом мала.
Если пакет теряется, то сервер по таймауту отправляет пакет ещё раз.
Но если пакет долго шел и сервер отправил пакет ещё раз, и они оба дошли до клиента, то клиент должен отправить два подтверждения и получаются излишние пакеты.</p>
<h2 id="tcp"><a class="header" href="#tcp">TCP</a></h2>
<p>TCP очень сложный, мы рассмотрим только некоторые его части.</p>
<p>Важно понимать, что порты TCP и UDP не связаны.</p>
<p>IANA собирает список популярных портов с их назначением, например 80 - HTTP, 443 - HTTPS.</p>
<p>Поля пакета TCP:</p>
<ul>
<li>Source port</li>
<li>Destination port</li>
<li>Payload</li>
<li>Data offset - размер заголовка</li>
<li>Sequence number - смещение данных пакета в большом куске данных, который передаётся.</li>
<li>Acknowledgement number - номер последнего пакета, который принял клиент.</li>
</ul>
<p>Основная идея — не будем дожидаться подтверждения от получателя, отправим ему ещё данных.
Но нельзя посылать слишком много данных сразу, иначе пакеты начнут теряться.
Мы не получим ACK на какой-то пакет, и начиная с этого пакета отправим данные ещё раз.
Поэтому в TCP есть понятие <strong>Congestion Window</strong> - расстояние между указателем на последний отправленный пакет и последний ACKнутый пакет.
Для выбора размера окна используется Slow Start - будем экспоненциально увеличивать размер окна, пока данные не начнут теряться.</p>
<p>Мы не хотим отправлять ACK на каждый пакет, слишком много метаданных и мало информации.
Поэтому есть задержка, в течение которой мы ждём новые пакеты, чтобы ACKнуть сразу несколько.</p>
<p>Сервер перепосылает пакеты (если они потерялись) по таймауту.
Но хотелось бы, чтобы клиент уведомлял сервер, что пакет потерялся, чтобы сервер не ждал таймаут.
Это называется <strong>Fast Retransmit</strong>.
Если пришел пакет 1, а затем пришел пакет 3, то клиент немного ждёт (вдруг порядок пакетов перепутался) и шлёт на пакет 3 опять ACK 1.
Это значит, что клиент получил ещё пакеты (после 1), но подтвердить может только 1.</p>
<p>Есть также <strong>Selective acknowledgements</strong>.
При соединении клиент и сервер могут договориться, что они поддерживают эту технологию, и тогда клиент сможет говорить, что он получил пакеты вплоть до N-того, кроме некоторого отрезка.
Обычно эта фича выключена.</p>
<h3 id="Подбор-congestion-window"><a class="header" href="#Подбор-congestion-window">Подбор congestion window</a></h3>
<p>Исторически первый алгоритм подбора окна - AIMD - Additive increase, multiplicative decrease.
Если пакет дошел, то увеличиваем окно на 1, иначе делим размер окна на 2.
<img src="img/aimd.png" alt="aimd" /></p>
<p>BIC - будем медленнее (по параболе) подкрадываться к окну, с которого нас сбросили.
<img src="img/bic.png" alt="bic" /></p>
<p>CUBIC - если пробили окно и поднялись достаточно высоко, то начнём расти быстро.
<img src="img/cubic.png" alt="cubic" /></p>
<p>Если у сервера много клиентов с алгоритмом CUBIC и похожими константами, разделение будет равным.
Если к этому же серверу придет клиент с AIMD, то он проиграет — ему достанется меньшая доля соединения.</p>
<p>BBR - давайте попробуем выбирать окно, не используя потерю пакетов.
Будем отступать, когда RTT начинает увеличиваться — это значит, что пакеты стоят долго в очередях. 
Алгоритм изначально придуман гуглом, он включил его у себя и получил улучшение в десятки процентов.
Но при включении BBR в интернете стало все плохо - BBR доминирует над кубиком и забирает себе канал, т.к. CUBIC наступает на потерю пакетов, а BBR немного отступает до неё, продолжая посылать пакеты быстро.</p>
<p>BBR 2 - BBR с костылями, чтобы не доминировать над кубиком.</p>
<h3 id="explicit-congestion-notification"><a class="header" href="#explicit-congestion-notification">Explicit Congestion Notification</a></h3>
<p>Как мы уже говорили, в IP пакете есть флаги ECN-Enabled и EC (случился).
Если ECN-Enabled выставлен и роутер считает, что скоро пакеты начнут теряться, то он выставит в пакете EC.
Но ECN получит сервер, а не клиент.
Если клиент просто отошлёт назад пакет с выставленными ECN и EC, то непонятно, на каком пути случился congestion - от клиента к серверу или наоборот.
Поэтому <em>в TCP пакете</em> есть флаг ECE - Explicit Congestion Echo, он гласит, что congestion случился на пути именно от клиента к серверу.
Если сервер получает пакет с ECE, то он должен уменьшить своё окно и отправить клиенту пакет с выставленным CWR (Congestion Window Reduced). 
В это время клиент, пока не получит CWR, будет слать пакеты с ECE.</p>
<p>Бывает такая ситуация, что данные доходят до ОС, но пользовательское приложение не успевает доставать данные из буфера ОС.
Тогда нужно просить сервер притормозить, за это отвечает поле window size.
Через него клиент говорит серверу, какой размер окна нужно выставить, в частности можно приостановить трафик, передав туда 0.</p>
<h3 id="tcp-3-way-handshake"><a class="header" href="#tcp-3-way-handshake">TCP 3-way handshake</a></h3>
<p>В идеальном мире клиент мог бы просто прийти к серверу и начать посылать ему данные.
Сервер при получении такого пакета сервер создавал бы буфер, выделял память и начинает работу.
Проблема: создание TCP-соединения это дорого - нужно выделять буфера, сокет, чего-то думать.
Плохие люди могут кушать таким образом ресурсы сервера, посылая пакеты с разных адресов (фейковых) и открывая много соединений.
Клиенту этот процесс ничего не стоит (послать один пакет), поэтому это очень простая атака.</p>
<p>В реальности клиент сначала посылает пакет с выставленным флажком SYN.
Если сервер хочет установить с клиентом соединение, то он отправляет SYN-ACK, в котором есть просьба начать нумеровать поток данных с некоторого числа.
Число считается statelessно из номера клиента и некоторого секрета на сервере.
Поэтому выделение ресурсов на сервере произойдет только после ответа клиента с ACK, который при этом должен учесть просьбу о нумерации.
Таким образом сервер проверяет адекватность клиента — что он слушает пакеты на src адресе (не фейкует его) и что он готов выделить сколько-то ресурсов, чтобы установить соединение.</p>
<p>Есть проблема — мы не можем создать соединение быстрее, чем 1.5 RTT.
Давайте будем выдавать клиенту число, называемое SYN Cookie, по которому он может обходить three-way handshake.</p>
<p>Флаг FIN гласит, что эта сторона больше не будет передавать данные.
Для полного закрытия нужен FIN с обеих сторон.
Проблема: девайс или прога может умереть и соединение не закроется. Если прога умирает, но ОС работает, то ОС говорит, что на порте никто не слушает. Если нет, то соединение закроется по таймауту.</p>
<p>В каждом TCP соединении есть на самом деле два канала — обычный и Urgent. Это экзотика.</p>
<p>Флаг PSH (Push) требует, чтобы ОС отдала приложению данные сразу и не делала буферизацию.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="lecture_3.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="lecture_5.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="lecture_3.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="lecture_5.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
